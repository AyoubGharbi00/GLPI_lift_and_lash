<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GLPI Lite Online - Gestion IT Collaborative</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                    }
                }
            }
        }
    </script>
    <style>
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .sidebar-item:hover {
            background: rgba(59, 130, 246, 0.1);
            border-right: 3px solid #3b82f6;
        }
        .sidebar-item.active {
            background: rgba(59, 130, 246, 0.15);
            border-right: 3px solid #3b82f6;
            color: #3b82f6;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800" onload="checkExistingSessionOnLoad()">
    <!-- Sync Status Indicator -->
    <div id="syncStatus" class="sync-indicator hidden">
        <div class="bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg flex items-center space-x-2">
            <i class="fas fa-sync fa-spin"></i>
            <span>Synchronisation...</span>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="fixed inset-0 gradient-bg flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4 slide-in">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-cube text-2xl text-blue-600"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">GLPI Lite Online</h1>
                <p class="text-gray-500 text-sm mt-2">Gestion IT Collaborative</p>
                <div class="mt-2 inline-flex items-center px-3 py-1 rounded-full bg-green-100 text-green-800 text-xs">
                    <i class="fas fa-wifi mr-1"></i> Mode Online
                </div>
            </div>
            
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="loginEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition" placeholder="admin@glpi-lite.com" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Mot de passe</label>
                    <input type="password" id="loginPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition" placeholder="••••••••" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition font-medium">
                    <i class="fas fa-sign-in-alt mr-2"></i>Connexion
                </button>
            </form>
            
            <div class="mt-6 text-center text-xs text-gray-500">
                <p>Comptes démo :</p>
                <p class="mt-1">admin@glpi-lite.com / admin</p>
                <p>tech@glpi-lite.com / tech</p>
                <p>user@glpi-lite.com / user</p>
            </div>
            
            <div class="mt-4 p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                <p class="text-xs text-yellow-800 text-center">
                    <i class="fas fa-info-circle mr-1"></i>
                    Pour configurer votre propre base de données, voir instructions ci-dessous
                </p>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" class="hidden min-h-screen flex">
        <!-- Sidebar -->
        <aside class="w-64 bg-white shadow-lg fixed h-full z-40 hidden md:block">
            <div class="p-6 border-b border-gray-100">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-cube text-white"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg text-gray-800">GLPI Lite</h1>
                        <p class="text-xs text-gray-500" id="userRoleDisplay">Admin</p>
                        <div class="flex items-center mt-1">
                            <span class="w-2 h-2 bg-green-500 rounded-full mr-1"></span>
                            <span class="text-xs text-green-600">Online</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <nav class="mt-6 px-4 space-y-1">
                <a href="#" onclick="showSection('dashboard')" class="sidebar-item active flex items-center px-4 py-3 text-gray-700 rounded-lg transition" id="nav-dashboard">
                    <i class="fas fa-chart-line w-6"></i>
                    <span class="font-medium">Tableau de bord</span>
                </a>
                <a href="#" onclick="showSection('tickets')" class="sidebar-item flex items-center px-4 py-3 text-gray-700 rounded-lg transition" id="nav-tickets">
                    <i class="fas fa-ticket-alt w-6"></i>
                    <span class="font-medium">Tickets</span>
                    <span id="ticketBadge" class="ml-auto bg-red-500 text-white text-xs px-2 py-1 rounded-full hidden">0</span>
                </a>
                <a href="#" onclick="showSection('assets')" class="sidebar-item flex items-center px-4 py-3 text-gray-700 rounded-lg transition" id="nav-assets">
                    <i class="fas fa-laptop w-6"></i>
                    <span class="font-medium">Parc Informatique</span>
                </a>
                <a href="#" onclick="showSection('maintenance')" class="sidebar-item flex items-center px-4 py-3 text-gray-700 rounded-lg transition" id="nav-maintenance">
                    <i class="fas fa-wrench w-6"></i>
                    <span class="font-medium">Maintenance</span>
                </a>
                <a href="#" onclick="showSection('users')" class="sidebar-item flex items-center px-4 py-3 text-gray-700 rounded-lg transition admin-only" id="nav-users">
                    <i class="fas fa-users w-6"></i>
                    <span class="font-medium">Utilisateurs</span>
                </a>
                <a href="#" onclick="showSection('stats')" class="sidebar-item flex items-center px-4 py-3 text-gray-700 rounded-lg transition" id="nav-stats">
                    <i class="fas fa-chart-bar w-6"></i>
                    <span class="font-medium">Statistiques</span>
                </a>
            </nav>
            
            <div class="absolute bottom-0 w-full p-4 border-t border-gray-100">
                <div class="flex items-center px-4 py-2">
                    <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-user text-gray-600 text-sm"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900 truncate" id="sidebarUserName">Admin</p>
                        <p class="text-xs text-gray-500 truncate" id="sidebarUserEmail">admin@glpi-lite.com</p>
                    </div>
                    <button onclick="logout()" class="text-gray-400 hover:text-red-500 transition">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Mobile Header -->
        <div class="md:hidden fixed top-0 w-full bg-white shadow-md z-30 px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fas fa-cube text-blue-600 text-xl"></i>
                <span class="font-bold text-lg">GLPI Lite</span>
                <span class="w-2 h-2 bg-green-500 rounded-full ml-2"></span>
            </div>
            <button onclick="toggleMobileMenu()" class="text-gray-600">
                <i class="fas fa-bars text-xl"></i>
            </button>
        </div>

        <!-- Mobile Menu -->
        <div id="mobileMenu" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden" onclick="toggleMobileMenu()">
            <div class="bg-white w-64 h-full p-4" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="font-bold text-lg">Menu</h2>
                    <button onclick="toggleMobileMenu()" class="text-gray-500">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <nav class="space-y-2">
                    <a href="#" onclick="showSection('dashboard'); toggleMobileMenu()" class="block px-4 py-2 rounded-lg hover:bg-gray-100">Tableau de bord</a>
                    <a href="#" onclick="showSection('tickets'); toggleMobileMenu()" class="block px-4 py-2 rounded-lg hover:bg-gray-100">Tickets</a>
                    <a href="#" onclick="showSection('assets'); toggleMobileMenu()" class="block px-4 py-2 rounded-lg hover:bg-gray-100">Parc Informatique</a>
                    <a href="#" onclick="showSection('maintenance'); toggleMobileMenu()" class="block px-4 py-2 rounded-lg hover:bg-gray-100">Maintenance</a>
                    <a href="#" onclick="showSection('users'); toggleMobileMenu()" class="block px-4 py-2 rounded-lg hover:bg-gray-100 admin-only">Utilisateurs</a>
                    <a href="#" onclick="showSection('stats'); toggleMobileMenu()" class="block px-4 py-2 rounded-lg hover:bg-gray-100">Statistiques</a>
                    <hr class="my-4">
                    <button onclick="logout()" class="w-full text-left px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg">
                        <i class="fas fa-sign-out-alt mr-2"></i>Déconnexion
                    </button>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <main class="flex-1 md:ml-64 p-4 md:p-8 mt-14 md:mt-0">
            
            <!-- Dashboard Section -->
            <section id="dashboard" class="section-content fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Tableau de bord</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-sm p-6 card-hover transition border-l-4 border-blue-500">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm text-gray-500 mb-1">Total Tickets</p>
                                <h3 class="text-3xl font-bold text-gray-800" id="dashTotalTickets">0</h3>
                            </div>
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-ticket-alt text-blue-600 text-xl"></i>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-2">Tous les tickets</p>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-6 card-hover transition border-l-4 border-yellow-500">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm text-gray-500 mb-1">En cours</p>
                                <h3 class="text-3xl font-bold text-gray-800" id="dashOpenTickets">0</h3>
                            </div>
                            <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-clock text-yellow-600 text-xl"></i>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-2">Tickets actifs</p>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-6 card-hover transition border-l-4 border-green-500">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm text-gray-500 mb-1">Résolus</p>
                                <h3 class="text-3xl font-bold text-gray-800" id="dashResolvedTickets">0</h3>
                            </div>
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-check-circle text-green-600 text-xl"></i>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-2">Ce mois-ci</p>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-6 card-hover transition border-l-4 border-purple-500">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm text-gray-500 mb-1">Équipements</p>
                                <h3 class="text-3xl font-bold text-gray-800" id="dashTotalAssets">0</h3>
                            </div>
                            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-laptop text-purple-600 text-xl"></i>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-2">Dans le parc</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="font-bold text-lg mb-4">Tickets récents</h3>
                        <div id="recentTicketsList" class="space-y-3">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="font-bold text-lg mb-4">Équipements en panne</h3>
                        <div id="brokenAssetsList" class="space-y-3">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Tickets Section -->
            <section id="tickets" class="section-content hidden fade-in">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">Gestion des Tickets</h2>
                    <button onclick="openTicketModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center">
                        <i class="fas fa-plus mr-2"></i>Nouveau Ticket
                    </button>
                </div>

                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="p-4 border-b border-gray-100 flex flex-col md:flex-row gap-4">
                        <div class="flex-1 relative">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                            <input type="text" id="ticketSearch" placeholder="Rechercher un ticket..." class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" onkeyup="filterTickets()">
                        </div>
                        <select id="ticketStatusFilter" class="px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" onchange="filterTickets()">
                            <option value="">Tous les statuts</option>
                            <option value="Nouveau">Nouveau</option>
                            <option value="En cours">En cours</option>
                            <option value="Résolu">Résolu</option>
                        </select>
                        <select id="ticketPriorityFilter" class="px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" onchange="filterTickets()">
                            <option value="">Toutes priorités</option>
                            <option value="Urgent">Urgent</option>
                            <option value="Normal">Normal</option>
                        </select>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Titre</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Demandeur</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Service</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Priorité</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="ticketsTableBody" class="divide-y divide-gray-200">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Assets Section -->
            <section id="assets" class="section-content hidden fade-in">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">Parc Informatique</h2>
                    <button onclick="openAssetModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center admin-only">
                        <i class="fas fa-plus mr-2"></i>Ajouter Équipement
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="assetsGrid">
                    <!-- Dynamic content -->
                </div>
            </section>

            <!-- Maintenance Section -->
            <section id="maintenance" class="section-content hidden fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Historique de Maintenance</h2>
                
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="space-y-6" id="maintenanceTimeline">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </section>

            <!-- Users Section -->
            <section id="users" class="section-content hidden fade-in">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">Gestion des Utilisateurs</h2>
                    <button onclick="openUserModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center">
                        <i class="fas fa-plus mr-2"></i>Nouvel Utilisateur
                    </button>
                </div>

                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rôle</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Service</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody" class="divide-y divide-gray-200">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Stats Section -->
            <section id="stats" class="section-content hidden fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Statistiques</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="font-bold text-lg mb-4">Tickets par statut</h3>
                        <canvas id="statusChart" width="400" height="200"></canvas>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="font-bold text-lg mb-4">Tickets par service</h3>
                        <canvas id="serviceChart" width="400" height="200"></canvas>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="font-bold text-lg mb-4">Temps de résolution moyen</h3>
                    <div class="flex items-center justify-center py-8">
                        <div class="text-center">
                            <div class="text-5xl font-bold text-blue-600 mb-2" id="avgResolutionTime">0h</div>
                            <p class="text-gray-500">Temps moyen de résolution</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal: New Ticket -->
    <div id="ticketModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto slide-in">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <h3 class="text-xl font-bold">Nouveau Ticket</h3>
                <button onclick="closeTicketModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="ticketForm" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Titre</label>
                    <input type="text" name="title" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea name="description" rows="3" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Service</label>
                        <select name="service" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="Production">Production</option>
                            <option value="Administration">Administration</option>
                            <option value="RH">RH</option>
                            <option value="Logistique">Logistique</option>
                            <option value="Direction">Direction</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Priorité</label>
                        <select name="priority" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="Normal">Normal</option>
                            <option value="Urgent">Urgent</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeTicketModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition">Annuler</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Créer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: New Asset -->
    <div id="assetModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg slide-in">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <h3 class="text-xl font-bold">Nouvel Équipement</h3>
                <button onclick="closeAssetModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="assetForm" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nom</label>
                    <input type="text" name="name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                        <select name="type" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="PC">PC</option>
                            <option value="Imprimante">Imprimante</option>
                            <option value="Serveur">Serveur</option>
                            <option value="Scanner">Scanner</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Numéro de série</label>
                        <input type="text" name="serial" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Localisation</label>
                        <input type="text" name="location" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">État</label>
                        <select name="status" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="En service">En service</option>
                            <option value="En panne">En panne</option>
                            <option value="Stock">Stock</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date d'achat</label>
                    <input type="date" name="purchaseDate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeAssetModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition">Annuler</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Ajouter</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: New User -->
    <div id="userModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg slide-in">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <h3 class="text-xl font-bold">Nouvel Utilisateur</h3>
                <button onclick="closeUserModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="userForm" class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Prénom</label>
                        <input type="text" name="firstName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nom</label>
                        <input type="text" name="lastName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" name="email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Rôle</label>
                        <select name="role" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="user">Employé</option>
                            <option value="tech">Technicien</option>
                            <option value="admin">Administrateur</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Service</label>
                        <select name="department" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="Production">Production</option>
                            <option value="Administration">Administration</option>
                            <option value="RH">RH</option>
                            <option value="Logistique">Logistique</option>
                            <option value="Direction">Direction</option>
                            <option value="IT">IT</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Mot de passe</label>
                    <input type="password" name="password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeUserModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition">Annuler</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Créer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Ticket Details -->
    <div id="ticketDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto slide-in">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <h3 class="text-xl font-bold">Détails du Ticket</h3>
                <button onclick="closeTicketDetailModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="ticketDetailContent" class="p-6">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ============================================
        // FIREBASE CONFIGURATION - REPLACE WITH YOURS
        // ============================================
        // Step 1: Go to https://firebase.google.com/ and create a free account
        // Step 2: Create a new project
        // Step 3: Add a web app to your project
        // Step 4: Copy the config object and paste it below
        // Step 5: Enable Firestore Database in "Database" section
        
         const firebaseConfig = {
            apiKey: "AIzaSyCXK2_BvyMKt0z2FrXHSkb1pFc3zxmItVE",
            authDomain: "gpli-lift-and-lash.firebaseapp.com",
            projectId: "gpli-lift-and-lash",
            storageBucket: "gpli-lift-and-lash.firebasestorage.app",
            messagingSenderId: "991885081401",
            appId: "1:991885081401:web:ae9e8834c6bd58c51ec6e8",
            measurementId: "G-H9FLJK4EH6"
        };

        // Initialize Firebase (if config is valid)
        let db = null;
        let isOnline = false;
        
        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                isOnline = true;
                console.log("✅ Firebase connected - ONLINE MODE");
            } else {
                console.log("⚠️ Using demo mode - add your Firebase config to enable online sync");
                isOnline = false;
            }
        } catch (error) {
            console.error("Firebase init error:", error);
            isOnline = false;
        }

        // ============================================
        // DATA MANAGEMENT - Works both Online & Offline
        // ============================================
        
        let currentUser = null;
        const SESSION_KEY = 'glpi_lite_session';
        
        // Session persistence
        function saveSession(user) {
            if (user) {
                sessionStorage.setItem(SESSION_KEY, JSON.stringify(user));
            } else {
                sessionStorage.removeItem(SESSION_KEY);
            }
        }
        
        function loadSession() {
            try {
                const session = sessionStorage.getItem(SESSION_KEY);
                if (session) {
                    return JSON.parse(session);
                }
            } catch (e) {
                console.error('Session load error:', e);
            }
            return null;
        }
        
        function checkExistingSession() {
            const sessionUser = loadSession();
            if (sessionUser) {
                currentUser = sessionUser;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                initApp();
                return true;
            }
            return false;
        }
        
        function checkExistingSessionOnLoad() {
            setTimeout(() => {
                if (!currentUser) {
                    checkExistingSession();
                }
            }, 100);
        }

        // Local data (fallback when offline)
        let localUsers = [
            { id: 1, firstName: 'Admin', lastName: 'System', email: 'admin@glpi-lite.com', password: 'admin', role: 'admin', department: 'IT' },
            { id: 2, firstName: 'Tech', lastName: 'Support', email: 'tech@glpi-lite.com', password: 'tech', role: 'tech', department: 'IT' },
            { id: 3, firstName: 'Jean', lastName: 'Dupont', email: 'user@glpi-lite.com', password: 'user', role: 'user', department: 'Production' },
            { id: 4, firstName: 'Marie', lastName: 'Martin', email: 'marie.martin@company.com', password: 'pass123', role: 'user', department: 'RH' },
            { id: 5, firstName: 'Pierre', lastName: 'Bernard', email: 'pierre.bernard@company.com', password: 'pass123', role: 'tech', department: 'IT' }
        ];

        let localTickets = [
            { id: 1, title: 'Imprimante ne répond plus', description: 'L\'imprimante du bureau 302 ne répond plus depuis ce matin.', requester: 'marie.martin@company.com', service: 'RH', priority: 'Normal', status: 'En cours', createdAt: '2024-01-15', resolvedAt: null, assignedTo: 'tech@glpi-lite.com' },
            { id: 2, title: 'PC lent au démarrage', description: 'Le PC de production prend 10 minutes à démarrer.', requester: 'jean.dupont@company.com', service: 'Production', priority: 'Normal', status: 'Nouveau', createdAt: '2024-01-16', resolvedAt: null, assignedTo: null },
            { id: 3, title: 'Serveur inaccessible', description: 'Le serveur de fichiers ne répond pas.', requester: 'admin@glpi-lite.com', service: 'IT', priority: 'Urgent', status: 'En cours', createdAt: '2024-01-14', resolvedAt: null, assignedTo: 'pierre.bernard@company.com' },
            { id: 4, title: 'Installation logiciel', description: 'Besoin d\'installer Office sur le nouveau poste.', requester: 'sophie.petit@company.com', service: 'Administration', priority: 'Normal', status: 'Résolu', createdAt: '2024-01-10', resolvedAt: '2024-01-11', assignedTo: 'tech@glpi-lite.com' }
        ];

        let localAssets = [
            { id: 1, name: 'PC-DELL-001', type: 'PC', serial: 'SN123456789', location: 'Bureau 302', status: 'En service', purchaseDate: '2023-01-15' },
            { id: 2, name: 'PRT-HP-001', type: 'Imprimante', serial: 'SN987654321', location: 'Bureau 302', status: 'En panne', purchaseDate: '2022-06-20' },
            { id: 3, name: 'SRV-DELL-001', type: 'Serveur', serial: 'SN456789123', location: 'Salle serveur', status: 'En service', purchaseDate: '2023-03-10' },
            { id: 4, name: 'PC-LENOVO-001', type: 'PC', serial: 'SN789123456', location: 'Production Ligne A', status: 'En service', purchaseDate: '2023-08-05' },
            { id: 5, name: 'SCAN-EPSON-001', type: 'Scanner', serial: 'SN321654987', location: 'Administration', status: 'En service', purchaseDate: '2022-12-01' }
        ];

        let localMaintenance = [
            { id: 1, assetId: 2, date: '2024-01-15', type: 'Réparation', description: 'Remplacement du tambour d\'impression', technician: 'tech@glpi-lite.com' },
            { id: 2, assetId: 1, date: '2024-01-10', type: 'Maintenance préventive', description: 'Nettoyage et mise à jour des pilotes', technician: 'pierre.bernard@company.com' }
        ];

        // Data getters (online or offline)
        async function getUsers() {
            if (isOnline && db) {
                const snapshot = await db.collection('users').get();
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }
            return localUsers;
        }

        async function getTickets() {
            if (isOnline && db) {
                const snapshot = await db.collection('tickets').get();
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }
            return localTickets;
        }

        async function getAssets() {
            if (isOnline && db) {
                const snapshot = await db.collection('assets').get();
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }
            return localAssets;
        }

        async function getMaintenance() {
            if (isOnline && db) {
                const snapshot = await db.collection('maintenance').orderBy('date', 'desc').get();
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }
            return localMaintenance;
        }

        // Data setters (online or offline)
        async function addTicket(ticket) {
            if (isOnline && db) {
                const docRef = await db.collection('tickets').add(ticket);
                return docRef.id;
            }
            ticket.id = Date.now();
            localTickets.push(ticket);
            return ticket.id;
        }

        async function updateTicket(id, updates) {
            if (isOnline && db) {
                await db.collection('tickets').doc(id.toString()).update(updates);
            } else {
                const index = localTickets.findIndex(t => t.id === id);
                if (index !== -1) {
                    localTickets[index] = { ...localTickets[index], ...updates };
                }
            }
        }

        async function addAsset(asset) {
            if (isOnline && db) {
                const docRef = await db.collection('assets').add(asset);
                return docRef.id;
            }
            asset.id = Date.now();
            localAssets.push(asset);
            return asset.id;
        }

        async function updateAsset(id, updates) {
            if (isOnline && db) {
                await db.collection('assets').doc(id.toString()).update(updates);
            } else {
                const index = localAssets.findIndex(a => a.id === id);
                if (index !== -1) {
                    localAssets[index] = { ...localAssets[index], ...updates };
                }
            }
        }

        async function addMaintenance(entry) {
            if (isOnline && db) {
                const docRef = await db.collection('maintenance').add(entry);
                return docRef.id;
            }
            entry.id = Date.now();
            localMaintenance.unshift(entry);
            return entry.id;
        }

        async function addUser(user) {
            if (isOnline && db) {
                const docRef = await db.collection('users').add(user);
                return docRef.id;
            }
            user.id = Date.now();
            localUsers.push(user);
            return user.id;
        }

        async function deleteUser(id) {
            if (isOnline && db) {
                await db.collection('users').doc(id.toString()).delete();
            } else {
                localUsers = localUsers.filter(u => u.id !== id);
            }
        }

        // Real-time listeners (online only)
        function setupRealtimeListeners() {
            if (!isOnline || !db) return;

            // Listen for tickets changes
            db.collection('tickets').onSnapshot((snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added' || change.type === 'modified' || change.type === 'removed') {
                        showSyncIndicator();
                        refreshAllData();
                    }
                });
            });

            // Listen for assets changes
            db.collection('assets').onSnapshot((snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added' || change.type === 'modified' || change.type === 'removed') {
                        showSyncIndicator();
                        refreshAllData();
                    }
                });
            });
        }

        function showSyncIndicator() {
            const indicator = document.getElementById('syncStatus');
            indicator.classList.remove('hidden');
            setTimeout(() => {
                indicator.classList.add('hidden');
            }, 2000);
        }

        async function refreshAllData() {
            await loadAllData();
            updateDashboard();
            renderTickets();
            renderAssets();
            renderMaintenance();
            renderUsers();
        }

        // Auth Functions
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            const users = await getUsers();
            const user = users.find(u => u.email === email && u.password === password);
            
            if (user) {
                currentUser = user;
                saveSession(user);
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                initApp();
            } else {
                alert('Email ou mot de passe incorrect');
            }
        });

        function logout() {
            currentUser = null;
            saveSession(null);
            document.getElementById('app').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('loginForm').reset();
        }

        // App Initialization
        async function initApp() {
            await loadAllData();
            setupRealtimeListeners();
            
            // Update UI
            document.getElementById('sidebarUserName').textContent = currentUser.firstName + ' ' + currentUser.lastName;
            document.getElementById('sidebarUserEmail').textContent = currentUser.email;
            document.getElementById('userRoleDisplay').textContent = getRoleLabel(currentUser.role);
            
            // Show/hide admin elements
            const adminElements = document.querySelectorAll('.admin-only');
            adminElements.forEach(el => {
                if (currentUser.role === 'admin') {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });

            // Initial render
            updateDashboard();
            renderTickets();
            renderAssets();
            renderMaintenance();
            renderUsers();
            updateStats();
        }

        async function loadAllData() {
            localUsers = await getUsers();
            localTickets = await getTickets();
            localAssets = await getAssets();
            localMaintenance = await getMaintenance();
        }

        function getRoleLabel(role) {
            const roles = { admin: 'Administrateur', tech: 'Technicien IT', user: 'Employé' };
            return roles[role] || role;
        }

        // Navigation
        function showSection(sectionId) {
            document.querySelectorAll('.section-content').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
            
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const navItem = document.getElementById('nav-' + sectionId);
            if (navItem) navItem.classList.add('active');
            
            if (sectionId === 'dashboard') updateDashboard();
            if (sectionId === 'stats') updateStats();
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            menu.classList.toggle('hidden');
        }

        // Dashboard Functions
        function updateDashboard() {
            document.getElementById('dashTotalTickets').textContent = localTickets.length;
            document.getElementById('dashOpenTickets').textContent = localTickets.filter(t => t.status !== 'Résolu').length;
            document.getElementById('dashResolvedTickets').textContent = localTickets.filter(t => t.status === 'Résolu').length;
            document.getElementById('dashTotalAssets').textContent = localAssets.length;
            
            const openCount = localTickets.filter(t => t.status !== 'Résolu').length;
            const badge = document.getElementById('ticketBadge');
            if (openCount > 0) {
                badge.textContent = openCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
            
            const recentTickets = localTickets.slice(-5).reverse();
            const recentHtml = recentTickets.map(ticket => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition cursor-pointer" onclick="showTicketDetail(${ticket.id})">
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900 truncate">${ticket.title}</p>
                        <p class="text-xs text-gray-500">${ticket.service} • ${ticket.createdAt}</p>
                    </div>
                    <span class="px-2 py-1 text-xs rounded-full ${getStatusColor(ticket.status)}">${ticket.status}</span>
                </div>
            `).join('');
            document.getElementById('recentTicketsList').innerHTML = recentHtml || '<p class="text-gray-400 text-sm">Aucun ticket</p>';
            
            const brokenAssets = localAssets.filter(a => a.status === 'En panne');
            const brokenHtml = brokenAssets.map(asset => `
                <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-exclamation-triangle text-red-500"></i>
                        <div>
                            <p class="text-sm font-medium text-gray-900">${asset.name}</p>
                            <p class="text-xs text-gray-500">${asset.type} • ${asset.location}</p>
                        </div>
                    </div>
                </div>
            `).join('');
            document.getElementById('brokenAssetsList').innerHTML = brokenHtml || '<p class="text-gray-400 text-sm">Aucun équipement en panne</p>';
        }

        // Ticket Functions
        function renderTickets() {
            const tbody = document.getElementById('ticketsTableBody');
            const statusFilter = document.getElementById('ticketStatusFilter').value;
            const priorityFilter = document.getElementById('ticketPriorityFilter').value;
            const searchTerm = document.getElementById('ticketSearch').value.toLowerCase();
            
            let filteredTickets = localTickets.filter(ticket => {
                if (statusFilter && ticket.status !== statusFilter) return false;
                if (priorityFilter && ticket.priority !== priorityFilter) return false;
                if (searchTerm && !ticket.title.toLowerCase().includes(searchTerm) && !ticket.id.toString().includes(searchTerm)) return false;
                return true;
            });

            if (currentUser.role === 'user') {
                filteredTickets = filteredTickets.filter(t => t.requester === currentUser.email);
            }

            tbody.innerHTML = filteredTickets.map(ticket => `
                <tr class="hover:bg-gray-50 transition">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">#${ticket.id}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 font-medium">${ticket.title}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${ticket.requester}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${ticket.service}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs rounded-full ${getPriorityColor(ticket.priority)}">${ticket.priority}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs rounded-full ${getStatusColor(ticket.status)}">${ticket.status}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ticket.createdAt}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="showTicketDetail(${ticket.id})" class="text-blue-600 hover:text-blue-900 mr-3">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${currentUser.role !== 'user' ? `
                            <button onclick="takeTicket(${ticket.id})" class="text-green-600 hover:text-green-900 mr-3" title="Prendre en charge">
                                <i class="fas fa-hand-paper"></i>
                            </button>
                            ${ticket.status !== 'Résolu' ? `
                                <button onclick="resolveTicket(${ticket.id})" class="text-purple-600 hover:text-purple-900" title="Résoudre">
                                    <i class="fas fa-check"></i>
                                </button>
                            ` : ''}
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function filterTickets() {
            renderTickets();
        }

        function getStatusColor(status) {
            const colors = {
                'Nouveau': 'bg-blue-100 text-blue-800',
                'En cours': 'bg-yellow-100 text-yellow-800',
                'Résolu': 'bg-green-100 text-green-800'
            };
            return colors[status] || 'bg-gray-100 text-gray-800';
        }

        function getPriorityColor(priority) {
            return priority === 'Urgent' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800';
        }

        function openTicketModal() {
            document.getElementById('ticketModal').classList.remove('hidden');
        }

        function closeTicketModal() {
            document.getElementById('ticketModal').classList.add('hidden');
            document.getElementById('ticketForm').reset();
        }

        document.getElementById('ticketForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const newTicket = {
                title: formData.get('title'),
                description: formData.get('description'),
                requester: currentUser.email,
                service: formData.get('service'),
                priority: formData.get('priority'),
                status: 'Nouveau',
                createdAt: new Date().toISOString().split('T')[0],
                resolvedAt: null,
                assignedTo: null
            };
            
            try {
                const id = await addTicket(newTicket);
                newTicket.id = id;
                
                if (newTicket.priority === 'Urgent') {
                    await addMaintenance({
                        ticketId: id,
                        date: newTicket.createdAt,
                        type: 'Ticket Urgent',
                        description: `Ticket #${id} créé: ${newTicket.title}`,
                        technician: 'Système'
                    });
                }
                
                closeTicketModal();
                await refreshAllData();
            } catch (error) {
                alert('Erreur lors de la création du ticket: ' + error.message);
            }
        });

        function showTicketDetail(id) {
            if (!currentUser) {
                const restored = checkExistingSession();
                if (!restored) {
                    alert('Session expirée. Veuillez vous reconnecter.');
                    logout();
                    return;
                }
            }
            
            const ticket = localTickets.find(t => t.id === id);
            if (!ticket) return;
            
            const content = document.getElementById('ticketDetailContent');
            content.innerHTML = `
                <div class="space-y-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="text-lg font-bold text-gray-900">${ticket.title}</h4>
                            <p class="text-sm text-gray-500">#${ticket.id} • Créé le ${ticket.createdAt}</p>
                        </div>
                        <div class="flex space-x-2">
                            <span class="px-3 py-1 rounded-full text-sm ${getPriorityColor(ticket.priority)}">${ticket.priority}</span>
                            <span class="px-3 py-1 rounded-full text-sm ${getStatusColor(ticket.status)}">${ticket.status}</span>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h5 class="font-semibold mb-2">Description</h5>
                        <p class="text-gray-700">${ticket.description}</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-500">Demandeur:</span>
                            <p class="font-medium">${ticket.requester}</p>
                        </div>
                        <div>
                            <span class="text-gray-500">Service:</span>
                            <p class="font-medium">${ticket.service}</p>
                        </div>
                        <div>
                            <span class="text-gray-500">Assigné à:</span>
                            <p class="font-medium">${ticket.assignedTo || 'Non assigné'}</p>
                        </div>
                        ${ticket.resolvedAt ? `
                            <div>
                                <span class="text-gray-500">Résolu le:</span>
                                <p class="font-medium">${ticket.resolvedAt}</p>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${currentUser.role !== 'user' && ticket.status !== 'Résolu' ? `
                        <div class="flex space-x-3 pt-4 border-t">
                            ${!ticket.assignedTo ? `
                                <button onclick="takeTicket(${ticket.id}); closeTicketDetailModal()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">
                                    Prendre en charge
                                </button>
                            ` : ''}
                            <button onclick="resolveTicket(${ticket.id}); closeTicketDetailModal()" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition">
                                Marquer comme résolu
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
            document.getElementById('ticketDetailModal').classList.remove('hidden');
        }

        function closeTicketDetailModal() {
            document.getElementById('ticketDetailModal').classList.add('hidden');
        }

        async function takeTicket(id) {
            if (!currentUser) {
                alert('Session expirée. Veuillez vous reconnecter.');
                logout();
                return;
            }
            const ticket = localTickets.find(t => t.id === id);
            if (ticket) {
                ticket.assignedTo = currentUser.email;
                ticket.status = 'En cours';
                
                try {
                    await updateTicket(id, { assignedTo: currentUser.email, status: 'En cours' });
                    
                    await addMaintenance({
                        ticketId: id,
                        date: new Date().toISOString().split('T')[0],
                        type: 'Prise en charge',
                        description: `Ticket #${id} pris en charge par ${currentUser.email}`,
                        technician: currentUser.email
                    });
                    
                    await refreshAllData();
                } catch (error) {
                    alert('Erreur: ' + error.message);
                }
            }
        }

        async function resolveTicket(id) {
            if (!currentUser) {
                alert('Session expirée. Veuillez vous reconnecter.');
                logout();
                return;
            }
            const ticket = localTickets.find(t => t.id === id);
            if (ticket) {
                const resolvedAt = new Date().toISOString().split('T')[0];
                
                try {
                    await updateTicket(id, { status: 'Résolu', resolvedAt: resolvedAt });
                    
                    await addMaintenance({
                        ticketId: id,
                        date: resolvedAt,
                        type: 'Résolution',
                        description: `Ticket #${id} résolu par ${currentUser.email}`,
                        technician: currentUser.email
                    });
                    
                    await refreshAllData();
                } catch (error) {
                    alert('Erreur lors de la résolution: ' + error.message);
                }
            }
        }

        // Asset Functions
        function renderAssets() {
            const grid = document.getElementById('assetsGrid');
            grid.innerHTML = localAssets.map(asset => `
                <div class="bg-white rounded-xl shadow-sm p-6 card-hover transition border-l-4 ${asset.status === 'En panne' ? 'border-red-500' : 'border-green-500'}">
                    <div class="flex justify-between items-start mb-4">
                        <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center">
                            <i class="fas ${getAssetIcon(asset.type)} text-2xl text-gray-600"></i>
                        </div>
                        <span class="px-2 py-1 text-xs rounded-full ${asset.status === 'En service' ? 'bg-green-100 text-green-800' : asset.status === 'En panne' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'}">
                            ${asset.status}
                        </span>
                    </div>
                    <h3 class="font-bold text-lg mb-1">${asset.name}</h3>
                    <p class="text-sm text-gray-500 mb-3">${asset.type} • ${asset.serial}</p>
                    <div class="space-y-1 text-sm text-gray-600">
                        <p><i class="fas fa-map-marker-alt w-5 text-gray-400"></i> ${asset.location}</p>
                        <p><i class="fas fa-calendar w-5 text-gray-400"></i> Acheté le ${asset.purchaseDate}</p>
                    </div>
                    ${currentUser.role !== 'user' ? `
                        <div class="mt-4 pt-4 border-t flex space-x-2">
                            <button onclick="toggleAssetStatus(${asset.id})" class="text-sm text-blue-600 hover:text-blue-800">
                                ${asset.status === 'En panne' ? 'Marquer réparé' : 'Signaler panne'}
                            </button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function getAssetIcon(type) {
            const icons = {
                'PC': 'fa-desktop',
                'Imprimante': 'fa-print',
                'Serveur': 'fa-server',
                'Scanner': 'fa-scanner'
            };
            return icons[type] || 'fa-laptop';
        }

        function openAssetModal() {
            document.getElementById('assetModal').classList.remove('hidden');
        }

        function closeAssetModal() {
            document.getElementById('assetModal').classList.add('hidden');
            document.getElementById('assetForm').reset();
        }

        document.getElementById('assetForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const newAsset = {
                name: formData.get('name'),
                type: formData.get('type'),
                serial: formData.get('serial'),
                location: formData.get('location'),
                status: formData.get('status'),
                purchaseDate: formData.get('purchaseDate')
            };
            
            try {
                await addAsset(newAsset);
                closeAssetModal();
                await refreshAllData();
            } catch (error) {
                alert('Erreur lors de l\'ajout de l\'équipement: ' + error.message);
            }
        });

        async function toggleAssetStatus(id) {
            const asset = localAssets.find(a => a.id === id);
            if (asset) {
                const oldStatus = asset.status;
                const newStatus = asset.status === 'En panne' ? 'En service' : 'En panne';
                
                try {
                    await updateAsset(id, { status: newStatus });
                    
                    await addMaintenance({
                        assetId: id,
                        date: new Date().toISOString().split('T')[0],
                        type: newStatus === 'En panne' ? 'Panne signalée' : 'Réparation',
                        description: `${asset.name} : ${oldStatus} → ${newStatus}`,
                        technician: currentUser.email
                    });
                    
                    await refreshAllData();
                } catch (error) {
                    alert('Erreur: ' + error.message);
                }
            }
        }

        // Maintenance Functions
        function renderMaintenance() {
            const container = document.getElementById('maintenanceTimeline');
            container.innerHTML = localMaintenance.map(m => {
                const asset = localAssets.find(a => a.id === m.assetId);
                const ticket = localTickets.find(t => t.id === m.ticketId);
                return `
                    <div class="flex space-x-4">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                            <i class="fas fa-wrench text-blue-600"></i>
                        </div>
                        <div class="flex-1 pb-6 border-l-2 border-gray-200 pl-4 relative">
                            <div class="absolute -left-2 top-0 w-4 h-4 rounded-full bg-blue-500 border-4 border-white"></div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-semibold text-gray-900">${m.type}</h4>
                                    <span class="text-sm text-gray-500">${m.date}</span>
                                </div>
                                <p class="text-gray-700 mb-2">${m.description}</p>
                                <div class="flex items-center text-sm text-gray-500">
                                    <i class="fas fa-user-circle mr-2"></i>
                                    <span>${m.technician}</span>
                                    ${asset ? `<span class="mx-2">•</span><span>${asset.name}</span>` : ''}
                                    ${ticket ? `<span class="mx-2">•</span><span>Ticket #${ticket.id}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // User Functions
        function renderUsers() {
            if (currentUser.role !== 'admin') return;
            
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = localUsers.map(user => `
                <tr class="hover:bg-gray-50 transition">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center mr-3">
                                <span class="text-sm font-medium text-gray-600">${user.firstName[0]}${user.lastName[0]}</span>
                            </div>
                            <div class="text-sm font-medium text-gray-900">${user.firstName} ${user.lastName}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs rounded-full ${getRoleBadgeColor(user.role)}">
                            ${getRoleLabel(user.role)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.department}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        ${user.id !== currentUser.id ? `
                            <button onclick="deleteUserById(${user.id})" class="text-red-600 hover:text-red-900">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function getRoleBadgeColor(role) {
            const colors = {
                admin: 'bg-purple-100 text-purple-800',
                tech: 'bg-blue-100 text-blue-800',
                user: 'bg-gray-100 text-gray-800'
            };
            return colors[role] || 'bg-gray-100 text-gray-800';
        }

        function openUserModal() {
            document.getElementById('userModal').classList.remove('hidden');
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.add('hidden');
            document.getElementById('userForm').reset();
        }

        document.getElementById('userForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const newUser = {
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                email: formData.get('email'),
                password: formData.get('password'),
                role: formData.get('role'),
                department: formData.get('department')
            };
            
            try {
                await addUser(newUser);
                closeUserModal();
                await refreshAllData();
            } catch (error) {
                alert('Erreur lors de la création de l\'utilisateur: ' + error.message);
            }
        });

        async function deleteUserById(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cet utilisateur ?')) {
                try {
                    await deleteUser(id);
                    await refreshAllData();
                } catch (error) {
                    alert('Erreur lors de la suppression: ' + error.message);
                }
            }
        }

        // Statistics Functions
        function updateStats() {
            // Status chart
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            const statusCounts = {
                'Nouveau': localTickets.filter(t => t.status === 'Nouveau').length,
                'En cours': localTickets.filter(t => t.status === 'En cours').length,
                'Résolu': localTickets.filter(t => t.status === 'Résolu').length
            };
            
            new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: ['#3b82f6', '#f59e0b', '#10b981']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Service chart
            const serviceCtx = document.getElementById('serviceChart').getContext('2d');
            const services = ['Production', 'Administration', 'RH', 'Logistique', 'Direction', 'IT'];
            const serviceCounts = services.map(s => localTickets.filter(t => t.service === s).length);
            
            new Chart(serviceCtx, {
                type: 'bar',
                data: {
                    labels: services,
                    datasets: [{
                        label: 'Tickets',
                        data: serviceCounts,
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            // Average resolution time
            const resolvedTickets = localTickets.filter(t => t.status === 'Résolu' && t.resolvedAt && t.createdAt);
            let totalHours = 0;
            resolvedTickets.forEach(t => {
                const created = new Date(t.createdAt);
                const resolved = new Date(t.resolvedAt);
                const hours = (resolved - created) / (1000 * 60 * 60);
                totalHours += hours;
            });
            const avgHours = resolvedTickets.length > 0 ? Math.round(totalHours / resolvedTickets.length) : 0;
            document.getElementById('avgResolutionTime').textContent = avgHours + 'h';
        }

        // Close modals on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('fixed')) {
                event.target.classList.add('hidden');
            }
        }
    </script>
</body>
</html>